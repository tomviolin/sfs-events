{"version":3,"sources":["@photo-sphere-viewer/core","src/index.ts","src/events.ts","src/ResolutionPlugin.ts"],"sourcesContent":["module.exports = PhotoSphereViewer","import { DEFAULTS } from '@photo-sphere-viewer/core';\nimport * as events from './events';\n\nDEFAULTS.lang.resolution = 'Quality';\n\nexport { ResolutionPlugin } from './ResolutionPlugin';\nexport * from './model';\nexport { events };\n","import { TypedEvent } from '@photo-sphere-viewer/core';\nimport type { ResolutionPlugin } from './ResolutionPlugin';\n\n/**\n * @event Triggered when the resolution is changed\n */\nexport class ResolutionChangedEvent extends TypedEvent<ResolutionPlugin> {\n    static override readonly type = 'resolution-changed';\n    override type: 'resolution-changed';\n\n    /** @internal */\n    constructor(public readonly resolutionId: string) {\n        super(ResolutionChangedEvent.type);\n    }\n}\n\nexport type ResolutionPluginEvents = ResolutionChangedEvent;\n","import type { Viewer } from '@photo-sphere-viewer/core';\nimport { AbstractPlugin, events, PSVError, utils } from '@photo-sphere-viewer/core';\nimport type { OptionsSetting, SettingsPlugin } from '@photo-sphere-viewer/settings-plugin';\nimport { ResolutionChangedEvent, ResolutionPluginEvents } from './events';\nimport { Resolution, ResolutionPluginConfig } from './model';\n\nconst getConfig = utils.getConfigParser<ResolutionPluginConfig>({\n    resolutions: null,\n    defaultResolution: null,\n    showBadge: true,\n});\n\n/**\n *  Adds a setting to choose between multiple resolutions of the panorama.\n */\nexport class ResolutionPlugin extends AbstractPlugin<ResolutionPluginEvents> {\n    static override readonly id = 'resolution';\n    static override readonly VERSION = PKG_VERSION;\n\n    readonly config: ResolutionPluginConfig;\n\n    private resolutions: Resolution[] = [];\n    private resolutionsById: Record<string, Resolution> = {};\n\n    private readonly state = {\n        resolution: null as string,\n    };\n\n    private settings: SettingsPlugin;\n\n    constructor(viewer: Viewer, config: ResolutionPluginConfig) {\n        super(viewer);\n\n        this.config = getConfig(config);\n\n        if (this.config.defaultResolution && this.viewer.config.panorama) {\n            utils.logWarn(\n                'ResolutionPlugin, a defaultResolution was provided ' +\n                    'but a panorama is already configured on the viewer, ' +\n                    'the defaultResolution will be ignored.'\n            );\n        }\n    }\n\n    /**\n     * @internal\n     */\n    override init() {\n        super.init();\n\n        this.settings = this.viewer.getPlugin('settings');\n\n        if (!this.settings) {\n            throw new PSVError('Resolution plugin requires the Settings plugin');\n        }\n\n        this.settings.addSetting({\n            id: ResolutionPlugin.id,\n            type: 'options',\n            label: this.viewer.config.lang.resolution,\n            current: () => this.state.resolution,\n            options: () => this.resolutions,\n            apply: (resolution) => this.__setResolutionIfExists(resolution),\n            badge: !this.config.showBadge ? null : () => this.state.resolution,\n        } as OptionsSetting);\n\n        this.viewer.addEventListener(events.PanoramaLoadedEvent.type, this);\n\n        if (this.config.resolutions) {\n            this.setResolutions(\n                this.config.resolutions,\n                this.viewer.config.panorama ? null : this.config.defaultResolution\n            );\n            delete this.config.resolutions;\n            delete this.config.defaultResolution;\n        }\n    }\n\n    /**\n     * @internal\n     */\n    override destroy() {\n        this.viewer.removeEventListener(events.PanoramaLoadedEvent.type, this);\n\n        this.settings.removeSetting(ResolutionPlugin.id);\n\n        super.destroy();\n    }\n\n    /**\n     * @internal\n     */\n    handleEvent(e: Event) {\n        if (e instanceof events.PanoramaLoadedEvent) {\n            this.__refreshResolution();\n        }\n    }\n\n    /**\n     * Changes the available resolutions\n     * @param resolutions\n     * @param defaultResolution - if not provided, the current panorama is kept\n     * @throws {@link PSVError} if the configuration is invalid\n     */\n    setResolutions(resolutions: Resolution[], defaultResolution?: string) {\n        this.resolutions = resolutions || [];\n        this.resolutionsById = {};\n\n        resolutions.forEach((resolution) => {\n            if (!resolution.id) {\n                throw new PSVError('Missing resolution id');\n            }\n            if (!resolution.panorama) {\n                throw new PSVError('Missing resolution panorama');\n            }\n            this.resolutionsById[resolution.id] = resolution;\n        });\n\n        // pick first resolution if no default provided and no current panorama\n        if (!this.viewer.config.panorama && !defaultResolution) {\n            defaultResolution = resolutions[0].id;\n        }\n\n        // ensure the default resolution exists\n        if (defaultResolution && !this.resolutionsById[defaultResolution]) {\n            utils.logWarn(`Resolution ${defaultResolution} unknown`);\n            defaultResolution = resolutions[0].id;\n        }\n\n        if (defaultResolution) {\n            this.setResolution(defaultResolution);\n        }\n\n        this.__refreshResolution();\n    }\n\n    /**\n     * Changes the current resolution\n     * @throws {@link PSVError} if the resolution does not exist\n     */\n    setResolution(id: string): Promise<unknown> {\n        if (!this.resolutionsById[id]) {\n            throw new PSVError(`Resolution ${id} unknown`);\n        }\n\n        return this.__setResolutionIfExists(id);\n    }\n\n    private __setResolutionIfExists(id: string): Promise<unknown> {\n        if (this.resolutionsById[id]) {\n            return this.viewer.setPanorama(this.resolutionsById[id].panorama, { transition: false, showLoader: false });\n        } else {\n            return Promise.resolve();\n        }\n    }\n\n    /**\n     * Returns the current resolution\n     */\n    getResolution(): string {\n        return this.state.resolution;\n    }\n\n    /**\n     * Updates current resolution on panorama load\n     */\n    private __refreshResolution() {\n        const resolution = this.resolutions.find((r) => utils.deepEqual(this.viewer.config.panorama, r.panorama));\n        if (this.state.resolution !== resolution?.id) {\n            this.state.resolution = resolution?.id;\n            this.settings?.updateButton();\n            this.dispatchEvent(new ResolutionChangedEvent(this.state.resolution));\n        }\n    }\n}\n"],"mappings":"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","names":["import_core","import_core"]}